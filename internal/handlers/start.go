package handlers

import (
	"DailyDoseBot/internal/db"
	"DailyDoseBot/internal/models"
	"DailyDoseBot/internal/utils"
	"fmt"

	"go.uber.org/zap"
	tele "gopkg.in/telebot.v4"
)

func StartHandler(b *tele.Bot, log *zap.Logger) func(c tele.Context) error {
	log.Info("StartHandler initialized")
	return func(c tele.Context) error {
		telegramID := c.Sender().ID
		name := c.Sender().FirstName

		var user models.User
		result := db.DB.First(&user, "telegram_id = ?", telegramID)

		menu := utils.MainMenuKeyboard()
		if result.Error != nil {
			user = models.User{
				TelegramID: telegramID,
				Name:       name,
			}
			if err := db.DB.Create(&user).Error; err != nil {
				log.Info("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", zap.Error(err))
				return c.Send("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ üôÅ")
			}

			// User-friendly –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
			msg := fmt.Sprintf("üëã –ü—Ä–∏–≤–µ—Ç, %s!\n\n–Ø ‚Äî DailyDoseBot, —Ç–≤–æ–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è —É—á—ë—Ç–∞ –∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –æ –ø—Ä–∏—ë–º–µ –≤–∏—Ç–∞–º–∏–Ω–æ–≤ –∏ –¥–æ–±–∞–≤–æ–∫ üíä.\n\n–ß—Ç–æ —è —É–º–µ—é:\n‚Ä¢ –ù–∞–ø–æ–º–∏–Ω–∞—Ç—å –æ –ø—Ä–∏—ë–º–µ –¥–æ–±–∞–≤–æ–∫ –≤ –Ω—É–∂–Ω–æ–µ –≤—Ä–µ–º—è (–º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –Ω–∞ –¥–µ–Ω—å)\n‚Ä¢ –ü–æ–º–æ–≥–∞—Ç—å –æ—Ç–º–µ—á–∞—Ç—å –ø—Ä–∏—ë–º –æ–¥–Ω–∏–º –Ω–∞–∂–∞—Ç–∏–µ–º\n‚Ä¢ –í–µ—Å—Ç–∏ –∏—Å—Ç–æ—Ä–∏—é –∏ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –∑–∞ –¥–µ–Ω—å –∏ –Ω–µ–¥–µ–ª—é\n‚Ä¢ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å—á–∏—Ç–∞—Ç—å –ø—Ä–æ—Ü–µ–Ω—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø–ª–∞–Ω–∞\n‚Ä¢ –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∑–∞ –Ω–µ–¥–µ–ª—é (–∫–∞–∂–¥—ã–π –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫)\n‚Ä¢ –ü–æ–º–æ–≥–∞—Ç—å –Ω–µ –∑–∞–±—ã—Ç—å –∑–∞–≤–µ—Ä—à–∏—Ç—å –∫—É—Ä—Å –∏–ª–∏ —Å–¥–∞—Ç—å –∞–Ω–∞–ª–∏–∑—ã\n\n–ö–∞–∫ –Ω–∞—á–∞—Ç—å:\n1Ô∏è‚É£ –î–æ–±–∞–≤—å —Å–≤–æ—é –ø–µ—Ä–≤—É—é –¥–æ–±–∞–≤–∫—É ‚Äî /add\n2Ô∏è‚É£ –ü–æ—Å–º–æ—Ç—Ä–∏ —Å–ø–∏—Å–æ–∫ –¥–æ–±–∞–≤–æ–∫ ‚Äî /list\n3Ô∏è‚É£ –û—Ç–º–µ—á–∞–π –ø—Ä–∏—ë–º —á–µ—Ä–µ–∑ /log –∏–ª–∏ –∫–Ω–æ–ø–∫–∏ –≤ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è—Ö\n4Ô∏è‚É£ –°–ª–µ–¥–∏ –∑–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º ‚Äî /status\n\n–ï—Å–ª–∏ –±—É–¥—É—Ç –≤–æ–ø—Ä–æ—Å—ã –∏–ª–∏ –ø–æ–∂–µ–ª–∞–Ω–∏—è ‚Äî –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏ –º–Ω–µ ‚ù§Ô∏è\n\n–ó–¥–æ—Ä–æ–≤—å—è –∏ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã!", name)
			return c.Send(msg, menu)
		}

		msg := fmt.Sprintf("üëã –ü—Ä–∏–≤–µ—Ç —Å–Ω–æ–≤–∞, %s!\n\n–†–∞–¥—ã –≤–∏–¥–µ—Ç—å —Ç–µ–±—è! –Ø –ø—Ä–æ–¥–æ–ª–∂–∞—é —Å–ª–µ–¥–∏—Ç—å –∑–∞ —Ç–≤–æ–∏–º –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º –∏ –Ω–∞–ø–æ–º–∏–Ω–∞—Ç—å –æ –ø—Ä–∏—ë–º–µ –¥–æ–±–∞–≤–æ–∫.\n\n–ù–µ –∑–∞–±—ã–≤–∞–π –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∫–æ–º–∞–Ω–¥–∞–º–∏:\n‚Ä¢ /add ‚Äî –¥–æ–±–∞–≤–∏—Ç—å –¥–æ–±–∞–≤–∫—É\n‚Ä¢ /list ‚Äî —Å–ø–∏—Å–æ–∫ –¥–æ–±–∞–≤–æ–∫\n‚Ä¢ /log ‚Äî –æ—Ç–º–µ—Ç–∏—Ç—å –ø—Ä–∏—ë–º\n‚Ä¢ /status ‚Äî —Å—Ç–∞—Ç—É—Å –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å –∑–∞ —Å–µ–≥–æ–¥–Ω—è\n\n–ö–∞–∂–¥—ã–π –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ —è –ø—Ä–∏—à–ª—é —Ç–µ–±–µ –Ω–µ–¥–µ–ª—å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É! üí™", user.Name)
		return c.Send(msg, menu)
	}
}
